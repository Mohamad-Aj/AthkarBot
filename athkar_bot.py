import telebot
import logging
import threading
import time
import random
from dotenv import load_dotenv
import os

# Load environment variables
load_dotenv()

# Get the bot token from .env
BOT_TOKEN = os.getenv("ATHKAR_TOKEN")

bot = telebot.TeleBot(BOT_TOKEN)
logger = logging.getLogger(__name__)
logging.basicConfig(
    format="[%(levelname)s %(asctime)s %(module)s:%(lineno)d] %(message)s",
    level=logging.INFO,
)

# Athkar from the **Quran, Sahih Al-Bukhari, and Sahih Muslim**
athkar_list = [
    # ๐ ุฃุฏุนูุฉ ูู ุงููุฑุขู ุงููุฑูู
    " ูููููู ุขููุงุชููู ุฃููู ุฎููููู ููููู ููููู ุฃููููุณููููู ุฃูุฒูููุงุฌูุง ูููุชูุณููููููุง ุฅูููููููุง ููุฌูุนููู ุจูููููููู ูููููุฏููุฉู ููุฑูุญูููุฉู ๏ดพ (ุงูุฑูู: 21) ๏ดฟ" ,
    " ุฑูุจููููุง ููุจู ููููุง ูููู ุฃูุฒูููุงุฌูููุง ููุฐูุฑูููููุงุชูููุง ููุฑููุฉู ุฃูุนููููู ููุงุฌูุนูููููุง ููููููุชููููููู ุฅูููุงููุง ๏ดพ (ุงููุฑูุงู: 74) ๏ดฟ" ,
    " ููุฃููููุญููุง ูฑููุฃููููฐููููฐ ููููููู ูููฑูุตูููฐููุญูููู ูููู ุนูุจูุงุฏููููู ููุฅูููุขุฆููููู ๏ดพ (ุงูููุฑ: 32) ๏ดฟ",
    " ููุณูุขุคููููู ุญูุฑูุซู ููููููู ููุฃูุชููุง ุญูุฑูุซููููู ุฃููููููฐ ุดูุฆูุชููู ๏ดพ (ุงูุจูุฑุฉ: 223) ๏ดฟ",
    " ููููููููู ููุซููู ูฑูููุฐูู ุนูููููููููู ุจููฑููููุนูุฑูููู ๏ดพ (ุงูุจูุฑุฉ: 228) ๏ดฟ",
    " ูููฑููููุญูุตููููฐุชู ูููู ูฑููููุคููููููฐุชู ูููฑููููุญูุตููููฐุชู ูููู ูฑูููุฐูููู ุฃููุชููุงู ูฑููููุชููฐุจู ๏ดพ (ุงููุงุฆุฏุฉ: 5) ๏ดฟ",
    " ููุฅูู ุทูุจููู ููููู ุนูู ุดูููุกูข ููููููู ููููุณูญุง ููููููููู ูููููููููญุง ูููุฑููููููญุง ๏ดพ (ุงููุณุงุก: 4) ๏ดฟ",
    " ููุฅูู ููุชูููุฑููููุง ููุบููู ูฑูููููู ูููููขุง ูููู ุณูุนูุชูููฆ ๏ดพ (ุงููุณุงุก: 130) ๏ดฟ",
    " ููููุง ุชููููุญููุง ูฑููููุดูุฑููููฐุชู ุญูุชููููฐ ููุคูููููู ๏ดพ (ุงูุจูุฑุฉ: 221) ๏ดฟ",
    " ุฑูุจูู ุฅููููู ููููุง ุฃูููุฒูููุชู ุฅูููููู ูููู ุฎูููุฑู ูููููุฑู ๏ดพ (ุงููุตุต: 24) ๏ดฟ",  

    # ๐ ุฃุญุงุฏูุซ ูุจููุฉ ุนู ุงูุฒูุงุฌ
    # ๐ ุฃุฏุนูุฉ ุนูุฏ ุงูุฒูุงุฌ ูุงูุนูุฏ
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ุฅุฐุง ุชุฒูููุฌู ุฃุญุฏููููู ุงูุฑุฃุฉู ูููุฃุฎุฐู ุจูุงุตูุชููุงุ ููููุณููู ุงููููุ ูููููุฏูุนู ุจุงูุจุฑููุฉู. (ุฑูุงู ุฃุจู ุฏุงูุฏ ูุตุญุญู ุงูุฃูุจุงูู)",
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ุจุงุฑู ุงููู ููุ ูุจุงุฑู ุนูููุ ูุฌูุน ุจููููุง ูู ุฎูุฑ. (ุฑูุงู ุงูุชุฑูุฐู ูุฃุจู ุฏุงูุฏ ูุตุญุญู ุงูุฃูุจุงูู)",

    # ๐ ุฏุนุงุก ุงููุจู ๏ทบ ูููุฉ ุงูุฒูุงุฌ
    "ูุงู ุงููุจู ๏ทบ ุฅุฐุง ุชุฒูุฌ ูุงู: ุงูููู ุฅูู ุฃุณุฃูู ุฎูุฑูุง ูุฎูุฑ ูุง ุฌุจูุชูุง ุนูููุ ูุฃุนูุฐ ุจู ูู ุดุฑูุง ูุดุฑ ูุง ุฌุจูุชูุง ุนููู. (ุฑูุงู ุฃุจู ุฏุงูุฏ ูุงุจู ูุงุฌู ูุตุญุญู ุงูุฃูุจุงูู)",

    # ๐ ุฏุนุงุก ุนูุฏ ุงูุฏุฎูู ุจุงูุฒูุฌุฉ
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ุฅุฐุง ุชุฒููุฌ ุฃุญุฏูู ุงูุฑุฃุฉุ ุฃู ุงุดุชุฑู ุฎุงุฏููุงุ ููููู: ุงูููู ุฅูู ุฃุณุฃูู ุฎูุฑูุงุ ูุฎูุฑ ูุง ุฌุจูุชูุง ุนูููุ ูุฃุนูุฐ ุจู ูู ุดุฑูุงุ ูุดุฑ ูุง ุฌุจูุชูุง ุนููู. (ุฑูุงู ุฃุจู ุฏุงูุฏ ูุงุจู ูุงุฌู ูุตุญุญู ุงูุฃูุจุงูู)",

    # ๐ ูุถู ุงูุฒูุฌุฉ ุงูุตุงูุญุฉ
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ุงูุฏููุง ูุชุงุนุ ูุฎูุฑ ูุชุงุน ุงูุฏููุง ุงููุฑุฃุฉ ุงูุตุงูุญุฉ. (ุฑูุงู ูุณูู)",
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ุฃุฑุจุน ูู ุงูุณุนุงุฏุฉ: ุงููุฑุฃุฉ ุงูุตุงูุญุฉุ ูุงููุณูู ุงููุงุณุนุ ูุงูุฌุงุฑ ุงูุตุงูุญุ ูุงููุฑูุจ ุงููููุก. (ุฑูุงู ุงุจู ุญุจุงู ูุตุญุญู ุงูุฃูุจุงูู)",

    # ๐ ุฏุนุงุก ุงูุจุฑูุฉ ูููุชุฒูุฌูู
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ุงูููู ุจุงุฑู ูููุงุ ูุจุงุฑู ุนููููุงุ ูุงุฌูุน ุจููููุง ูู ุฎูุฑ. (ุฑูุงู ุงูุชุฑูุฐู ูุฃุจู ุฏุงูุฏ ูุตุญุญู ุงูุฃูุจุงูู)",

    # ๐ ุงูุญุซ ุนูู ุงูุฒูุงุฌ
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ูุง ูุนุดุฑ ุงูุดุจุงุจุ ูู ุงุณุชุทุงุน ูููู ุงูุจุงุกุฉ ูููุชุฒูุฌุ ูุฅูู ุฃุบุถ ููุจุตุฑ ูุฃุญุตู ูููุฑุฌ. (ุฑูุงู ุงูุจุฎุงุฑู ููุณูู)",

    # ๐ ุฏุนุงุก ุนูุฏ ุงูุฌูุงุน
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ูู ุฃู ุฃุญุฏูู ุฅุฐุง ุฃุชู ุฃููู ูุงู: ุจุณู ุงูููุ ุงูููู ุฌูุจูุง ุงูุดูุทุงูุ ูุฌูุจ ุงูุดูุทุงู ูุง ุฑุฒูุชูุงุ ูุฅูู ุฅู ูููุฏูุฑ ุจููููุง ููุฏุ ูู ูุถุฑู ุงูุดูุทุงู ุฃุจุฏูุง. (ุฑูุงู ุงูุจุฎุงุฑู ููุณูู)",

    # ๐ ุญุณู ุงููุนุงุดุฑุฉ ุจูู ุงูุฒูุฌูู
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ุฎูุฑููู ุฎูุฑููู ูุฃููููู ูุฃูุง ุฎูุฑููู ูุฃูููู. (ุฑูุงู ุงูุชุฑูุฐู ูุตุญุญู ุงูุฃูุจุงูู)",
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ุฃููููู ุงููุคููููู ุฅููุงููุง ุฃุญุณูููู ุฎููููุงุ ูุฎูุงุฑููู ุฎูุงุฑููู ููุณุงุฆูููู. (ุฑูุงู ุงูุชุฑูุฐู ูุตุญุญู ุงูุฃูุจุงูู)",
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ุงุณุชูุตูุง ุจุงููุณุงุก ุฎูุฑูุงุ ูุฅููู ุฎูููู ูู ุถูุน. (ุฑูุงู ุงูุจุฎุงุฑู ููุณูู)",

    # ๐ ุงูุญุซ ุนูู ุงูุฒูุงุฌ ูู ุงููุฑุฃุฉ ุงูุตุงูุญุฉ
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ุชูููุญ ุงููุฑุฃุฉ ูุฃุฑุจุน: ููุงููุงุ ููุญุณุจูุงุ ููุฌูุงููุงุ ููุฏูููุงุ ูุงุธูุฑ ุจุฐุงุช ุงูุฏูู ุชูุฑูุจูุช ูุฏุงู. (ุฑูุงู ุงูุจุฎุงุฑู ููุณูู)",

    # ๐ ุฏุนุงุก ุงูุชูููู ุจูู ุงูุฒูุฌูู
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ุซูุงุซุฉ ุญู ุนูู ุงููู ุนูููู: ุงููุฌุงูุฏ ูู ุณุจูู ุงูููุ ูุงูููุงุชุจ ุงูุฐู ูุฑูุฏ ุงูุฃุฏุงุกุ ูุงููุงูุญ ุงูุฐู ูุฑูุฏ ุงูุนูุงู. (ุฑูุงู ุงูุชุฑูุฐู ูุตุญุญู ุงูุฃูุจุงูู)",

    # ๐ ุฏุนุงุก ููุฃููุฉ ูุงูููุฏุฉ ุจูู ุงูุฒูุฌูู
    "ุงูููู ุฃูู ุจูู ูููุจูุงุ ูุฃุตูุญ ุฐุงุช ุจูููุงุ ูุงูุฏูุง ุณุจู ุงูุณูุงูุ ููุฌูุง ูู ุงูุธููุงุช ุฅูู ุงูููุฑ. (ุญุฏูุซ ุญุณู ุฑูุงู ุฃุจู ุฏุงูุฏ ูุตุญุญู ุงูุฃูุจุงูู)",

    # ๐ ุฏุนุงุก ููุจุฑูุฉ ูู ุงูุญูุงุฉ ุงูุฒูุฌูุฉ
    "ุงูููู ุงุฌุนู ุจููู ูุจูู ุฒูุฌู ููุฏุฉ ูุฑุญูุฉ ููุง ุฃูุฑุชุ ูุจุงุฑู ููุง ูู ุญูุงุชูุง ุงูุฒูุฌูุฉ. (ุฑูุงู ุงูุจุฎุงุฑู ููุณูู ุจูุนูุงู)",

    # ๐ ุฏุนุงุก ูุญูุธ ุงูุนูุงูุฉ ุงูุฒูุฌูุฉ ูู ุงูุดูุทุงู
    "ูุงู ุฑุณูู ุงููู ๏ทบ: ุฅู ุงูุดูุทุงู ูุฌุฑู ูู ุงุจู ุขุฏู ูุฌุฑู ุงูุฏูุ ูุงุฌุนููุง ุจูููู ูุจููู ุณุชุฑูุง ุจุงูุตูุงุฉ ูุงูุฏุนุงุก. (ุฑูุงู ุงูุจุฎุงุฑู ููุณูู)",

    # ๐ ุฏุนุงุก ุนูุฏ ุงูุฎูุงู ุจูู ุงูุฒูุฌูู
    "ุงูููู ุฃุตูุญ ุจููู ูุจูู ุฒูุฌูุ ูุงูุฏูุง ููุง ุชุญุจ ูุชุฑุถูุ ูุจุงุฑู ููุง ูู ุญูุงุชูุง ุงูุฒูุฌูุฉ. (ูุณุชูุจุท ูู ุฃุฏุนูุฉ ุงููุจู ๏ทบ ูู ุฅุตูุงุญ ุฐุงุช ุงูุจูู)",

    # ๐ ุฏุนุงุก ูุญูุธ ุงูุฒูุฌ ูุงูุฒูุฌุฉ ูู ุงููุชูุฉ
    "ุงูููู ุงุญูุธูู ุจุญูุงูู ุนู ุญุฑุงููุ ูุงุบููู ุจูุถูู ุนููู ุณูุงู. (ุฑูุงู ุงูุชุฑูุฐู ูุตุญุญู ุงูุฃูุจุงูู)",

    # ๐ ุฏุนุงุก ูุฌูุจ ุงูุญุจ ูุงูููุฏุฉ ุจูู ุงูุฒูุฌูู
    "ุงูููู ุงุฌุนููู ูุฑุฉ ุนูู ูุฒูุฌูุ ูุงุฌุนูู ูุฑุฉ ุนูู ููุ ูุงุฑุฒููุง ุงูุฐุฑูุฉ ุงูุตุงูุญุฉ. (ุฑูุงู ูุณูู ุจูุนูุงู)",

    # ๐ ุฏุนุงุก ูุญุณู ุงูุนุดุฑุฉ ูุงููุนุงุดุฑุฉ ุงูุทูุจุฉ
    "ุงูููู ุงุฑุฒููู ุญุณู ุงูุนุดุฑุฉุ ูุจุงุฑู ูู ูู ุฒูุฌูุ ูุฃุตูุญ ุจูููุงุ ูุงุฌุนููุง ูู ุนุจุงุฏู ุงูุตุงูุญูู. (ุญุฏูุซ ุญุณู ุจูุนูุงู)",

    # ๐ ุฏุนุงุก ุนูุฏ ุฑุคูุฉ ุงูุฒูุฌ ุฃู ุงูุฒูุฌุฉ ูุฃูู ูุฑุฉ ุจุนุฏ ุงูุนูุฏ
    "ุงูููู ุงุฌุนููุง ูุจุงุฑูุฉ ููุ ูุจุงุฑู ูู ูููุงุ ูุงุฑุฒููุง ุงูุชูููู ูุงูุฐุฑูุฉ ุงูุตุงูุญุฉ. (ุฑูุงู ุงูุจุฎุงุฑู ุจูุนูุงู)",

    # ๐ ุฏุนุงุก ุนูุฏ ูุฌูุฏ ูุดุงูู ุฒูุฌูุฉ
    "ุงูููู ุงูุฏูู ูุฃุญุณู ุงูุฃุฎูุงูุ ูุงุตุฑู ุนูู ุณูุฆูุงุ ูุงูุฏูู ุฅูู ุงูุญูุ ูุงุฑุฒููู ุงูุญููุฉ ูู ุงูุชุนุงูู ูุน ุฒูุฌู (ุฃู ุฒูุฌุชู). (ุฑูุงู ูุณูู ุจูุนูุงู)",

    # ๐ ุฏุนุงุก ุนูุฏ ูุฏูู ุงูููููุฏ ุจุนุฏ ุงูุฒูุงุฌ
    "ุงูููู ุงุฌุนูู ูุจุงุฑููุงุ ูุฃุตูุญูุ ูุงูุจุชู ูุจุงุชูุง ุญุณููุงุ ูุงุฌุนูู ูุฑุฉ ุนูู ููุง. (ุฑูุงู ุงูุจุฎุงุฑู ููุณูู ุจูุนูุงู)",

    # ๐ ุฏุนุงุก ูุญูุธ ุงูุจูุช ูุงูุฃุณุฑุฉ
    "ุงูููู ุงุญูุธ ุจูุชูุ ูุงุฌุนููุง ูู ุฑุนุงูุชู ูุญูุธูุ ูุจุงุฑู ููุง ูู ุฒูุงุฌูุง ูุฃููุงุฏูุง. (ุฑูุงู ูุณูู ุจูุนูุงู)",

    # ๐ ุฏุนุงุก ุนูุฏ ุงูุญุงุฌุฉ ุฅูู ุงูุตุจุฑ ุนูู ุงูุฒูุฌ/ุงูุฒูุฌุฉ
    "ุงูููู ุงุฑุฒููู ุงูุตุจุฑุ ูุฃุนูู ุนูู ุญุณู ุงูุนุดุฑุฉุ ูุงูุฏูุง ููุง ุชุญุจ ูุชุฑุถู. (ุฑูุงู ุงูุจุฎุงุฑู ููุณูู ุจูุนูุงู)",

    # ๐ ุฏุนุงุก ุนูุฏ ููุฏุงู ุงูุฒูุฌ ุฃู ุงูุฒูุฌุฉ
    "ุงูููู ุฃุฌุฑูู ูู ูุตูุจุชูุ ูุงุฎูููู ุฎูุฑูุง ูููุง. (ุฑูุงู ูุณูู)",

    # ๐ ุฏุนุงุก ุนูุฏ ุงูุทูุงู ุฃู ุงูุงููุตุงู
    "ุงูููู ุฅู ูุงู ุฎูุฑูุง ููุง ูุงุฌูุนูุงุ ูุฅู ูุงู ุดุฑูุง ููุง ูุงุตุฑูู ุนูุงุ ูููููุง ููุง ููู ุงูุฎูุฑ ููุง ูู ุฏูููุง ูุฏููุงูุง. (ูุณุชูุจุท ูู ุฃุฏุนูุฉ ุงููุจู ๏ทบ ูู ุงููุชู ูุงูุดุฏุงุฆุฏ)",   
]


user_timers = {}
user_intervals = {}  # Store custom intervals per user (in seconds)

def send_athkar_to_user(chat_id):
    """Send a random Athkar to the user and restart the timer."""
    if chat_id in user_timers:
        athkar = random.choice(athkar_list)
        try:
            bot.send_message(chat_id, athkar)
        except Exception as e:
            logger.error(f"Failed to send Athkar to {chat_id}: {e}")

        # Restart timer with user's custom interval
        interval = user_intervals.get(chat_id, 1800)  # Default to 30 minutes if not set
        user_timers[chat_id] = threading.Timer(interval, send_athkar_to_user, [chat_id])
        user_timers[chat_id].start()

@bot.message_handler(commands=["start"])
def send_welcome(message: telebot.types.Message):
    """Send welcome message with instructions."""
    logger.info(f"- User started: {message.chat.username}")
    welcome_text = (
        "๐ ูุฑุญุจูุง ุจู ูู ุจูุช ุงูุฃุฐูุงุฑ!\n\n"
        "๐ ููุงุดุชุฑุงู ูู ุงูุฃุฐูุงุฑุ ุฃุฑุณู: **/subscribe**\n"
        "๐ ูุฅูุบุงุก ุงูุงุดุชุฑุงูุ ุฃุฑุณู: **/unsubscribe**\n"
        "๐ ูุชุบููุฑ ุงูุชูููุชุ ุฃุฑุณู: **/settime <ุนุฏุฏ ุงูุฏูุงุฆู>**\n"
        "๐ ุณุชุชููู ุงูุฃุฐูุงุฑ ุญุณุจ ุงููุฏุฉ ุงูุชู ุชุญุฏุฏูุง."
    )
    bot.reply_to(message, welcome_text)

@bot.message_handler(commands=["subscribe"])
def subscribe_user(message: telebot.types.Message):
    """Subscribe a user and start sending Athkar at their chosen interval."""
    chat_id = message.chat.id
    if chat_id not in user_timers:
        bot.reply_to(message, "โ ุชู ุชุณุฌููู ูุงุณุชูุจุงู ุงูุฃุฐูุงุฑ ูู 30 ุฏูููุฉ (ุงูุชุฑุงุถููุง).")

        # Default interval 30 minutes (1800 seconds)
        user_intervals[chat_id] = 1800
        user_timers[chat_id] = threading.Timer(1, send_athkar_to_user, [chat_id])  # Send first Athkar in 1 second
        user_timers[chat_id].start()
    else:
        bot.reply_to(message, "๐ ุฃูุช ูุดุชุฑู ุจุงููุนู!")

@bot.message_handler(commands=["unsubscribe"])
def unsubscribe_user(message: telebot.types.Message):
    """Unsubscribe a user and stop their Athkar timer."""
    chat_id = message.chat.id
    if chat_id in user_timers:
        user_timers[chat_id].cancel()  # Stop the timer
        del user_timers[chat_id]  # Remove from tracking
        del user_intervals[chat_id]  # Remove interval setting
        bot.reply_to(message, "โ ุชู ุฅูุบุงุก ุงุดุชุฑุงูู ููู ุชุณุชูุจู ุงูุฃุฐูุงุฑ ุจุนุฏ ุงูุขู.")
    else:
        bot.reply_to(message, "โ๏ธ ุฃูุช ุบูุฑ ูุดุชุฑู ุญุงูููุง.")

@bot.message_handler(commands=["settime"])
def set_user_interval(message: telebot.types.Message):
    """Allow a user to change their Athkar interval (in minutes)."""
    chat_id = message.chat.id
    args = message.text.split()
    
    if len(args) < 2 or not args[1].isdigit():
        bot.reply_to(message, "โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ุนุฏุฏ ุงูุฏูุงุฆู ุจุดูู ุตุญูุญุ ูุซุงู: **/settime 15**")
        return

    minutes = int(args[1])
    if minutes < 1:
        bot.reply_to(message, "โ๏ธ ุงูุญุฏ ุงูุฃุฏูู ูู ุฏูููุฉ ูุงุญุฏุฉ!")
        return

    interval_seconds = minutes * 60  # Convert minutes to seconds
    user_intervals[chat_id] = interval_seconds

    # Restart user's timer with new interval
    if chat_id in user_timers:
        user_timers[chat_id].cancel()
    
    user_timers[chat_id] = threading.Timer(interval_seconds, send_athkar_to_user, [chat_id])
    user_timers[chat_id].start()

    bot.reply_to(message, f"โ ุชู ุถุจุท ุงูุชูููุช! ุณุชุชููู ุงูุฃุฐูุงุฑ ูู **{minutes} ุฏูููุฉ**.")

# Start the bot
print("* Bot is running...")
bot.polling(none_stop=True)
